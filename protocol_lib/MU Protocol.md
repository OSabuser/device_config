# **MU_protocol — Протокол обмена данными между микроконтроллером и одноплатным компьютером**

## **1. Общее описание**

Протокол предназначен для передачи данных между **Python Server App** и **одноплатным компьютером** по UART. Протокол обеспечивает:

- Синхронизацию пакетов
- Целостность данных (через CRC16)
- Гибкость в передаче данных разных типов (определяется через `opcode`)

---

## **2. Структура пакета**

Каждый пакет состоит из следующих полей:

| Поле       | Размер | Тип      | Описание |
|------------|--------|----------|----------|
| `sync1`    | 1 байт | uint8    | Стартовый байт синхронизации, значение `0xAA` |
| `size`     | 1 байт | uint8    | Размер поля `data` в байтах (от 0 до 255) |
| `opcode`   | 1 байт | uint8    | Код операции (например, 0xDA для передачи данных о состоянии лифта) |
| `data`     | N байт | массив   | Полезная нагрузка |
| `crc16`    | 2 байта| uint16   | CRC-16 контрольная сумма |
| `sync2`    | 1 байт | uint8    | Конечный байт синхронизации, значение `0xBB` |

### **Общая длина пакета**:
```
Длина = 1 (sync1) + 1 (size) + 1 (opcode) + N (data) + 2 (crc16) + 1 (sync2) = 6 + N байт
```

---

## **3. Поля пакета**

### **3.1. `sync1` и `sync2`**
- Используются для синхронизации начала и конца пакета
- Значения: `0xAA` и `0xBB` соответственно

### **3.2. `size`**
- Определяет длину поля `data`
- Допустимые значения: от 0 до 255

### **3.3. `opcode`**
- Код операции, определяющий тип данных в поле `data`
- Примеры:
  - `0xDA` — данные о состоянии лифта
  - `0xDB` — команда от компьютера к микроконтроллеру
  - `0xDC` — подтверждение приёма
  - `0xDD` — запрос состояния
  - и т.д.

### **3.4. `data`**
- Полезная нагрузка, формат которой зависит от `opcode`
- Для `opcode: 0xDA` — строка вида `#STM:L%d:R%d:A%d:S%d:M%d:E#\r\n`

### **3.5. `crc16`**
- CRC-16 контрольная сумма, рассчитанная по следующим параметрам:

| Параметр   | Значение         |
|------------|------------------|
| Название   | CRC-16 CCITT     |
| Полином    | `0x1021` (`x^16 + x^12 + x^5 + 1`) |
| Начальное значение | `0xFFFF` |
| Реверс входных данных | Нет |
| Реверс результата     | Нет |
| Выходное XOR (`XorOut`)| `0x0000` |
| Контрольное значение (`"123456789"`) | `0x29B1` |
| Максимальная длина блока | 4095 байт (32767 бит) |

---

## **4. Пример пакета**

### **4.1. Исходные данные**
```c
opcode = 0xDA
data = "#STM:L10:R3:A1:S4:M0:E#\r\n"
```

### **4.2. Шаги формирования пакета**

1. Вычислить длину `data`: `len(data) = 24`
2. Установить `size = 24`
3. Вычислить CRC16 от последовательности: `opcode + data`
4. Сформировать пакет:

```
[0xAA] [0x18] [0xDA] [data bytes...] [CRC16_H] [CRC16_L] [0xBB]
```

---


